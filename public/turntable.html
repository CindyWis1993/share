<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta name="viewport" content="width=750,user-scalable=no" />
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <link href="https://static.yyfax.com/yyfaxgroup/lib/yyui/css/index-17cea18009.min.css" rel="stylesheet">
    <script src="https://static.yyfax.com/yyfax//lib/jquery/1.11.0/jquery.min.js"></script>
    <link href="./css/turntable.css" rel="stylesheet">
    <style class="turntableStyle"></style>
    <title>转盘</title>
</head>

<body>
    <div class="container">
        <p class="h3 color-main-fixed text-center" style="padding-bottom: 20px;">转盘</p>
        <div class="turntableMain border-shadow text-center">
            <input type="number" class="turntableNum" placeholder="请输入转盘格数(≥3)" value="3" />
            <button class="btn btn-default" onClick="turn('pan')">转盘转动</button>
            <button class="btn btn-default" onClick="turn('arrow')">指针转动</button>
            <button class="btn btn-default setTurntable">生成转盘</button>

            <div class="turntableCon">
                <ul class="turntable">
                    <li class="slice"></li>
                </ul>
                <div class="turntableArrow"></div>
            </div>

            <div class="alert">
                <div class="alertBox text-center">
                    <p class="prizeText"></p>
                    <button class="btn btn-default initTurntable">确定</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    var $turntable = $('.turntable');
    var $turntableNum = $('.turntableNum');
    var $turntableBtn = $('.setTurntable');
    var $turntableArrow = $('.turntableArrow');
    var $alert = $('.alert');
    var $sureBtn = $('.initTurntable');
    var degObg = {};
    var $style = $('.turntableStyle');
    var turnType = 'pan';
    var btnFlag = false;

    function color16() { //十六进制颜色随机
        var r = Math.floor(Math.random() * 256);
        var g = Math.floor(Math.random() * 256);
        var b = Math.floor(Math.random() * 256);
        var color = '#' + r.toString(16) + g.toString(16) + b.toString(16);
        return color;
    }

    function turn(type) {
        turnType = type;
    }

    $turntableBtn.click(() => {
        var turntableNum = $turntableNum.val();

        if (turntableNum < 3) {
            alert('建议转盘格数≥3');
            return;
        }

        $turntable.html('');
        var turntableHtml = '';

        for (var i = 0; i < turntableNum; i++) {
            var rotateDeg = i * (360 / turntableNum);
            var skewDeg = 360 / turntableNum - 90;
            var bgColor = color16();
            degObg[i] = rotateDeg;
            turntableHtml += `
                <li class="slice slice-${i}" 
                style="transform: rotate(${rotateDeg}deg) skewY(${skewDeg}deg); background: ${bgColor}">
                <span style="transform: rotate(0deg) skewY(${-skewDeg}deg)">商品${i + 1}</span></li>`
        }

        $turntable.html(turntableHtml);
    });

    $turntableArrow.click(() => {
        var turntableNum = $turntableNum.val();
        var turnTime = 0;

        if (turntableNum < 3) {
            alert('建议转盘格数≥3');
            return;
        }

        if (btnFlag) {
            return;
        }
        btnFlag = true;
        $style[0].innerHTML = '';

        if (turnType === 'pan') {
            var prizeId = parseInt(Math.random() * turntableNum);
            var rotateFinal = 360 * 5 + (360 - degObg[prizeId]) - 180 / turntableNum;
            turnTime = 2 / 3 * turntableNum;
            var turntableStyle = `
                .turntableAni {
                    transition: all ${turnTime}s ease-out;
                    transform: rotate(${rotateFinal}deg);
                }`;

            $style[0].type = 'text/css';
            $style[0].innerHTML = turntableStyle;

            $turntable.addClass('turntableAni');
        } else {
            var prizeId = parseInt(Math.random() * turntableNum);
            var rotateFinal = 360 * 5 + degObg[prizeId] + 180 / turntableNum;
            turnTime = 2 / 8 * turntableNum < 2 ? 2 : 2 / 8 * turntableNum;
            var turntableStyle = `
                .turntableAni {
                    transition: all ${turnTime}s ease-out;
                    transform: rotate(${rotateFinal}deg);
                }`;

            $style[0].type = 'text/css';
            $style[0].innerHTML = turntableStyle;

            $turntableArrow.addClass('turntableAni');
        }

        setTimeout(() => {
            $alert.find('.prizeText').text(`恭喜您抽中商品${prizeId + 1}`);
            $alert.show();
        }, turnTime * 1000 + 500);
    });

    $sureBtn.click(() => {
        btnFlag = false;
        $alert.hide();
        $style[0].innerHTML = '';
        $turntable.removeClass('turntableAni');
        $turntableArrow.removeClass('turntableAni');
    });

    $turntableBtn.click();
</script>

</html>